services:
  aphrodite:
    # 定义构建配置
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: aphrodite-openai
      args:
        CUDA_VERSION: "12.9.1"
        max_jobs: "20"
        nvcc_threads: "8"
        torch_cuda_arch_list: "7.5"

    # 构建出的镜像名称
    image: aphrodite-engine:latest
    container_name: aphrodite-glm47flash
    restart: unless-stopped

    # 共享内存配置
    ipc: host
    shm_size: "16gb"

    # 端口映射
    ports:
      - "2242:2242"

    environment:
      NVIDIA_VISIBLE_DEVICES: "0,1"
      HF_HOME: "/root/.cache/huggingface"
      HUGGINGFACE_HUB_TOKEN: "${HUGGINGFACE_HUB_TOKEN}"

    volumes:
      - ${HOME}/.cache/huggingface:/root/.cache/huggingface

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    command:
      [
        "cyankiwi/GLM-4.7-Flash-AWQ-4bit",
        "--host", "0.0.0.0",
        "--port", "2242",
        "--tensor-parallel-size", "2",
        "--max-model-len", "8192",
        "--quantization", "compressed-tensors"
      ]
